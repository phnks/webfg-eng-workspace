# Template for creating per-user agent containers
# This file will be used to generate user-specific docker-compose files

version: '3.8'

services:
  agent-USERNAME:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: AGENT_TYPE-agent  # autogen-agent or claude-code-agent
      args:
        USERNAME: USERNAME
        USER_UID: 1000
        USER_GID: 1000
    container_name: agent-USERNAME
    hostname: USERNAME
    networks:
      - agent-network
    volumes:
      - ./volumes/USERNAME/workspace:/home/USERNAME/workspace
      - ./volumes/USERNAME/claude:/home/USERNAME/.claude
      - ./volumes/USERNAME/config:/home/USERNAME/.config
      - ./volumes/USERNAME/ssh:/home/USERNAME/.ssh:ro
      - ./volumes/USERNAME/gitconfig:/home/USERNAME/.gitconfig:ro
      - ../autogen_agent:/home/USERNAME/autogen_agent:ro
      - ../mcp_servers/discord-mcp:/home/USERNAME/discord-mcp:ro
      - ../vm_cli:/home/USERNAME/vm_cli:ro
    environment:
      - USER=USERNAME
      - AGENT_TYPE=AGENT_TYPE
      - DEVCHAT_HOST_IP=host.docker.internal
      - DISCORD_BOT_TOKEN=${BOT_TOKEN_USERNAME}
      - DISCORD_CHANNEL_ID=${DISCORD_CHANNEL_ID}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    stdin_open: true
    tty: true
    restart: unless-stopped

networks:
  agent-network:
    external: true